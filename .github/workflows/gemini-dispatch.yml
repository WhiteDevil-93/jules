name: "\U0001F500 Gemini Dispatch"
true:
  pull_request_review_comment:
    types:
    - created
  pull_request_review:
    types:
    - submitted
  issues:
    types:
    - opened
    - reopened
  issue_comment:
    types:
    - created
defaults:
  run:
    shell: bash
jobs:
  debugger:
    if: ${{ fromJSON(vars.DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Print context for debugging
      env:
        DEBUG_event_name: ${{ github.event_name }}
        DEBUG_event__action: ${{ github.event.action }}
        DEBUG_event__comment__author_association: ${{ github.event.comment.author_association
          }}
        DEBUG_event__issue__author_association: ${{ github.event.issue.author_association
          }}
        DEBUG_event__pull_request__author_association: ${{ github.event.pull_request.author_association
          }}
        DEBUG_event__review__author_association: ${{ github.event.review.author_association
          }}
        DEBUG_event: ${{ toJSON(github.event) }}
      run: env | grep '^DEBUG_'
    timeout-minutes: 30
  dispatch:
    if: "(\n  github.event.sender.type == 'User' &&\n  startsWith(github.event.comment.body\
      \ || github.event.review.body || github.event.issue.body, '@gemini-cli') &&\n\
      \  contains(fromJSON('[\"OWNER\", \"MEMBER\", \"COLLABORATOR\"]'), github.event.comment.author_association\
      \ || github.event.review.author_association || github.event.issue.author_association)\n\
      ) || (\n  github.event_name == 'issues' &&\n  contains(fromJSON('[\"opened\"\
      , \"reopened\"]'), github.event.action)\n)"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    outputs:
      command: ${{ steps.extract_command.outputs.command }}
      request: ${{ steps.extract_command.outputs.request }}
      additional_context: ${{ steps.extract_command.outputs.additional_context }}
      issue_number: ${{ github.event.pull_request.number || github.event.issue.number
        }}
    steps:
    - name: Extract command
      id: extract_command
      uses: actions/github-script@v8
      env:
        EVENT_TYPE: ${{ github.event_name }}.${{ github.event.action }}
        REQUEST: ${{ github.event.comment.body || github.event.review.body || github.event.issue.body
          }}
      with:
        script: "const request = process.env.REQUEST;\nconst eventType = process.env.EVENT_TYPE\n\
          core.setOutput('request', request);\n\nif (request.startsWith(\"@gemini-cli\
          \ /review\")) {\n  core.setOutput('command', 'review');\n  const additionalContext\
          \ = request.replace(/^@gemini-cli \\/review/, '').trim();\n  core.setOutput('additional_context',\
          \ additionalContext);\n} else if (request.startsWith(\"@gemini-cli /triage\"\
          )) {\n  core.setOutput('command', 'triage');\n} else if (request.startsWith(\"\
          @gemini-cli\")) {\n  core.setOutput('command', 'invoke');\n  const additionalContext\
          \ = request.replace(/^@gemini-cli/, '').trim();\n  core.setOutput('additional_context',\
          \ additionalContext);\n} else if (['issues.opened', 'issues.reopened'].includes(eventType))\
          \ {\n  core.setOutput('command', 'triage');\n} else {\n  core.setOutput('command',\
          \ 'fallthrough');\n}\n"
    - name: Acknowledge request
      env:
        GITHUB_TOKEN: ${{ github.token }}
        ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number
          }}
        REPOSITORY: ${{ github.repository }}
      run: "# Add a lightweight emoji reaction instead of posting an acknowledgement\
        \ comment.\n# Prefer reaction on the triggering comment if present, otherwise\
        \ react on the issue/PR itself.\nCOMMENT_ID=$(jq -r '.comment.id // empty'\
        \ \"$GITHUB_EVENT_PATH\")\nif [ -n \"${COMMENT_ID}\" ]; then\n  # Use the\
        \ PR review comment endpoint for review comments\n  if [ \"$GITHUB_EVENT_NAME\"\
        \ = \"pull_request_review_comment\" ]; then\n    gh api -H \"Accept: application/vnd.github.squirrel-girl-preview+json\"\
        \ --method POST \\\n      /repos/${REPOSITORY}/pulls/comments/${COMMENT_ID}/reactions\
        \ -f content=\"rocket\" || true\n  else\n    gh api -H \"Accept: application/vnd.github.squirrel-girl-preview+json\"\
        \ --method POST \\\n      /repos/${REPOSITORY}/issues/comments/${COMMENT_ID}/reactions\
        \ -f content=\"rocket\" || true\n  fi\nelse\n  # Fallback: react to the issue\
        \ or PR itself\n  gh api -H \"Accept: application/vnd.github.squirrel-girl-preview+json\"\
        \ --method POST \\\n    /repos/${REPOSITORY}/issues/${ISSUE_NUMBER}/reactions\
        \ -f content=\"rocket\" || true\nfi"
    timeout-minutes: 30
  review:
    needs: dispatch
    if: ${{ needs.dispatch.outputs.command == 'review' }}
    uses: ./.github/workflows/gemini-review.yml
    permissions:
      contents: read
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
      language: ja
    secrets: inherit
    timeout-minutes: 30
  triage:
    needs: dispatch
    if: ${{ needs.dispatch.outputs.command == 'triage' && github.event.issue }}
    uses: ./.github/workflows/gemini-triage.yml
    permissions:
      contents: read
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
      language: ja
      gemini_debug: true
      gemini_model: gemini-2.5-flash-lite
    secrets: inherit
    timeout-minutes: 30
  invoke:
    needs: dispatch
    if: ${{ false && needs.dispatch.outputs.command == 'invoke' }}
    uses: ./.github/workflows/gemini-invoke.yml
    permissions:
      contents: read
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
      language: ja
    secrets: inherit
    timeout-minutes: 30
  fallthrough:
    needs:
    - dispatch
    - review
    - triage
    - invoke
    if: ${{ false && always() && !cancelled() && (failure() || needs.dispatch.outputs.command
      == 'fallthrough') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
    - name: Send failure comment
      env:
        GITHUB_TOKEN: ${{ github.token }}
        ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number
          }}
        REPOSITORY: ${{ github.repository }}
      run: "# Post a discrete reaction to the triggering comment/issue indicating\
        \ failure\nCOMMENT_ID=$(jq -r '.comment.id // empty' \"$GITHUB_EVENT_PATH\"\
        )\nif [ -n \"${COMMENT_ID}\" ]; then\n  if [ \"$GITHUB_EVENT_NAME\" = \"pull_request_review_comment\"\
        \ ]; then\n    gh api -H \"Accept: application/vnd.github.squirrel-girl-preview+json\"\
        \ --method POST \\\n      /repos/${REPOSITORY}/pulls/comments/${COMMENT_ID}/reactions\
        \ -f content=\"confused\" || true\n  else\n    gh api -H \"Accept: application/vnd.github.squirrel-girl-preview+json\"\
        \ --method POST \\\n      /repos/${REPOSITORY}/issues/comments/${COMMENT_ID}/reactions\
        \ -f content=\"confused\" || true\n  fi\nelse\n  gh api -H \"Accept: application/vnd.github.squirrel-girl-preview+json\"\
        \ --method POST \\\n    /repos/${REPOSITORY}/issues/${ISSUE_NUMBER}/reactions\
        \ -f content=\"confused\" || true\nfi"
    timeout-minutes: 30
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  issues: read
  pull-requests: read
