name: Release
true:
  push:
    tags:
    - v*
permissions:
  contents: write
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-node@v6
      with:
        node-version: 20.x
    - run: npm ci
    - run: npm run compile
    - name: Install xvfb
      run: sudo apt-get install -y xvfb
    - run: xvfb-run -a npm test
    - name: Install vsce
      run: npm install -g @vscode/vsce
    - name: Package extension
      run: vsce package
    - name: Create Release
      uses: actions/github-script@v8
      with:
        script: "const fs = require('fs');\nconst path = require('path');\n\nconst\
          \ vsixDir = './';\nconst files = fs.readdirSync(vsixDir);\nconst vsixFile\
          \ = files.find((file) => file.endsWith('.vsix'));\n\nif (!vsixFile) {\n\
          \  throw new Error('VSIX file not found. Ensure vsce package succeeded.');\n\
          }\n\nconst vsixPath = path.join(vsixDir, vsixFile);\nconst vsixData = fs.readFileSync(vsixPath);\n\
          const tagName = context.ref.replace('refs/tags/', '');\n\nasync function\
          \ ensureRelease() {\n  try {\n    const created = await github.rest.repos.createRelease({\n\
          \      owner: context.repo.owner,\n      repo: context.repo.repo,\n    \
          \  tag_name: tagName,\n      name: `Release ${tagName}`,\n      draft: false,\n\
          \      prerelease: false\n    });\n    core.info(`Created new release for\
          \ ${tagName}`);\n    return created.data;\n  } catch (error) {\n    if (error.status\
          \ !== 422) {\n      throw error;\n    }\n\n    core.info(`Release for ${tagName}\
          \ already exists. Reusing existing release.`);\n    const existing = await\
          \ github.rest.repos.getReleaseByTag({\n      owner: context.repo.owner,\n\
          \      repo: context.repo.repo,\n      tag: tagName\n    });\n    return\
          \ existing.data;\n  }\n}\n\nconst release = await ensureRelease();\n\nconst\
          \ assets = await github.paginate(github.rest.repos.listReleaseAssets, {\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n  release_id:\
          \ release.id,\n  per_page: 100\n});\n\nconst existingAsset = assets.find(asset\
          \ => asset.name === vsixFile);\nif (existingAsset) {\n  core.info(`Deleting\
          \ existing asset ${existingAsset.name} (id: ${existingAsset.id})`);\n  await\
          \ github.rest.repos.deleteReleaseAsset({\n    owner: context.repo.owner,\n\
          \    repo: context.repo.repo,\n    asset_id: existingAsset.id\n  });\n}\n\
          \nawait github.rest.repos.uploadReleaseAsset({\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  release_id: release.id,\n  name: vsixFile,\n\
          \  data: vsixData,\n  headers: {\n    'content-type': 'application/octet-stream',\n\
          \    'content-length': Buffer.byteLength(vsixData)\n  }\n});\n\ncore.info(`Release\
          \ ready at ${release.html_url}`);\ncore.info(`Uploaded VSIX asset ${vsixFile}`);\n"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    timeout-minutes: 30
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
