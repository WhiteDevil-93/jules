name: "\U0001F4CB Gemini Bulk Triage"
true:
  workflow_call:
    inputs:
      issues_to_triage:
        type: string
        description: JSON array of issues to triage
        required: true
      additional_context:
        type: string
        description: Any additional context from the request
        required: false
      language:
        type: string
        description: "Response language (default: 'ja' \u2014 JP)."
        default: ja
      gemini_model:
        type: string
        description: Gemini model override
        required: false
        default: ''
    outputs:
      available_labels:
        description: List of available labels
        value: ${{ jobs.triage_bulk.outputs.available_labels }}
      triaged_issues:
        description: JSON string of triaged issues
        value: ${{ jobs.triage_bulk.outputs.triaged_issues }}
    secrets:
      GEMINI_API_KEY:
        required: true
defaults:
  run:
    shell: bash
jobs:
  triage_bulk:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      issues: read
      pull-requests: read
    outputs:
      available_labels: ${{ steps.get_labels.outputs.available_labels }}
      triaged_issues: ${{ steps.collect_outputs.outputs.triaged_issues }}
    steps:
    - name: Get repository labels
      id: get_labels
      uses: actions/github-script@v8
      with:
        script: "const { data: labels } = await github.rest.issues.listLabelsForRepo({\n\
          \  owner: context.repo.owner,\n  repo: context.repo.repo,\n});\n\nif (!labels\
          \ || labels.length === 0) {\n  core.setFailed('There are no issue labels\
          \ in this repository.')\n}\n\nconst labelNames = labels.map(label => label.name).sort();\n\
          core.setOutput('available_labels', labelNames.join(','));\ncore.info(`Found\
          \ ${labelNames.length} labels: ${labelNames.join(', ')}`);\nreturn labelNames;"
    - name: Run Gemini Issue Analysis (bulk)
      id: gemini_issue_analysis
      uses: google-github-actions/run-gemini-cli@v0
      env:
        GITHUB_TOKEN: ${{ github.token }}
        ISSUES_TO_TRIAGE: ${{ inputs.issues_to_triage }}
        REPOSITORY: ${{ github.repository }}
        AVAILABLE_LABELS: ${{ steps.get_labels.outputs.available_labels }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      with:
        gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
        gemini_model: ${{ inputs.gemini_model || vars.GEMINI_MODEL || '' }}
        settings: "{\n  \"model\": {\n    \"maxSessionTurns\": 25\n  },\n  \"telemetry\"\
          : {\n    \"enabled\": false\n  },\n  \"tools\": {\n    \"core\": [\n   \
          \   \"run_shell_command\"\n    ]\n  }\n}"
        prompt: "\u51FA\u529B\u306F\u5FC5\u305A\u65E5\u672C\u8A9E\u3067\u884C\u3063\
          \u3066\u304F\u3060\u3055\u3044\u3002\n\u5FDC\u7B54\u8A00\u8A9E: ${{ inputs.language\
          \ }}\n\n## Role\nYou are a highly efficient Issue Triage Engineer. Your\
          \ task is to analyze the provided GitHub issues and assign the most relevant\
          \ labels from the available list.\n\n## Input Data\n\n**Available Labels:**\n\
          ${{ steps.get_labels.outputs.available_labels }}\n\n**Issues to Triage (JSON):**\n\
          ${{ inputs.issues_to_triage }}\n\n## Primary Directive\nAnalyze the issues\
          \ above and generate a JSON array containing your triage decisions.\n\n\
          Target File Path: /tmp/triaged_issues.json\n\nOutput Format (JSON Array):\n\
          [\n  {\n    \"issue_number\": <number>,\n    \"labels_to_set\": [\"<label1>\"\
          , \"<label2>\"],\n    \"explanation\": \"<brief explanation in Japanese>\"\
          \n  }\n]\n\n## Strict Output Rules\n1. You MUST NOT output the JSON content\
          \ in your text response.\n2. You MUST use the Python script below to write\
          \ the file to avoid quoting issues.\n\nExecute exactly this format:\nrun_shell_command(python3\
          \ -c \"import json; f=open('/tmp/triaged_issues.json', 'w'); json.dump(YOUR_ANALYSIS_RESULT_LIST,\
          \ f, ensure_ascii=False); f.close()\")\n\nWarning: Do not use example data.\
          \ Output the actual analysis results for the issues provided above.\nExecute\
          \ the Python script now."
    - name: Collect outputs
      id: collect_outputs
      uses: actions/github-script@v8
      with:
        script: "const fs = require('fs');\nconst path = '/tmp/triaged_issues.json';\n\
          let triagedIssues = '[]';\n\ntry {\n  if (fs.existsSync(path)) {\n    const\
          \ content = fs.readFileSync(path, 'utf8');\n    console.log('File content\
          \ preview:', content.substring(0, 100)); // \u30D7\u30EC\u30D3\u30E5\u30FC\
          \u3082\u51FA\u3059\n    // Validate JSON\n    JSON.parse(content);\n   \
          \ triagedIssues = content;\n  } else {\n    core.warning('\u26A0\uFE0F Output\
          \ file /tmp/triaged_issues.json was NOT found. Gemini likely failed to execute\
          \ the write command.');\n  }\n} catch (error) {\n  core.warning(`Error reading\
          \ or parsing triaged issues file: ${error.message}`);\n}\n\ncore.setOutput('triaged_issues',\
          \ triagedIssues);"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  issues: read
  pull-requests: read
